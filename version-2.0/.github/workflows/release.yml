name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: avatar-editor/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('avatar-editor/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./avatar-editor
        run: npm ci

      - name: Build project
        working-directory: ./avatar-editor
        run: npm run build

      - name: Create release package
        run: |
          mkdir -p release-package
          cp -r avatar-editor/dist release-package/
          cp -r avatar-editor/assets release-package/
          cp avatar-editor/index.html release-package/
          cp README.md release-package/ 2>/dev/null || true
          cd release-package
          zip -r ../habbo-avatar-editor-${{ github.ref_name }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: habbo-avatar-editor-${{ github.ref_name }}.zip
          body: |
            ## Habbo Avatar Editor Release ${{ github.ref_name }}

            ### Installation
            1. Download and extract the zip file
            2. Open `index.html` in a web browser
            3. The editor is ready to use!

            ### Contents
            - `dist/` - Compiled JavaScript bundle
            - `assets/` - Avatar assets and data files
            - `index.html` - Main HTML file

            ### Changes
            See commit history for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
